---
kind: source
spec:
  name: ldap_test
  registry: local
  path: /data/workspaces/gomods/cq-source-ldap/dist/cq-source-ldap_linux_amd64_v1/cq-source-ldap
  version: v0.1.0
  tables: 
    ["*"]
  destinations:
    - sqlite
  spec:
    endpoint: ${LDAP_ENDPOINT} # "ldap://ldap.example.com:389"
    username: ${LDAP_USERNAME} # "cn=read-only-admin,dc=example,dc=com"
    password: ${LDAP_PASSWORD} # "myP4$sW0Rd!"
    skiptls: true
    query:
      basedn: ${LDAP_BASEDN}
      filter: (&(objectclass=organizationalPerson)(cn=D*))
      #filter: (objectclass=organizationalPerson)
      scope: subtree
    table: 
      name: USERS
      filter: _.cn[0] startsWith 'D0'
      columns:
        - name: distinguished_name
          attribute: dn
          type: 
            from: string
            into: string
          key: true
          unique: true
          notnull: true
        - name: common_name
          attribute: cn
          type: 
            from: string
            into: string
        - name: logon_name
          attribute: sAMAccountName
          type: 
            from: string
            into: string
        - name: sid
          attribute: objectSID
          type:  
            from: sid
            into: string
        - name: full_name
          attribute: displayName
          type: 
            from: string
            into: string
        - name: first_name
          attribute: givenName
        - name: family_name
          attribute: sn
        - name: manager
        - name: reports
          attribute: directReports
          type: 
            from: "[]string"
            into: "[]string"
    # relations:
    #   - name: T1_UPPER
    #     filter: _.color startsWith 'blu'
    #     columns:
    #       - name: upper_color
    #         type: string
    #         key: true
    #         unique: true
    #         notnull: true
    #         transform: "{{index .Row \"color\" | toString | upper}}"
    #       - name: upper_value
    #         type: string
    #         transform: "{{index .Row \"value\" | toString | upper}}"
    #   - name: T1_UPPER
    #     filter: _.color startsWith 'bla'
    #     columns:
    #       - name: upper_color
    #         type: string
    #         key: true
    #         unique: true
    #         notnull: true
    #         transform: "{{index .Row \"color\" | toString | upper}}"
    #       - name: upper_value
    #         type: string
    #         transform: "{{index .Row \"value\" | toString | upper}}"
---
kind: destination
spec:
  name: sqlite
  path: cloudquery/sqlite
  version: v2.0.5
  spec:
    connection_string: ./import.sqlite
